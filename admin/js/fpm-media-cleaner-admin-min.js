!function($){"use strict";let e,t,i;function n(e,t="log"){console[t]("----------------------------------"),console[t]("[FPM Media Cleaner]"),console[t](`${e}`),console[t]("----------------------------------")}function a(e){let t,i,n,a,o;return t=e.getHours(),i=e.getMinutes(),n=e.getDate(),a=e.getMonth()+1,o=e.getFullYear(),t=t.toString().padStart(2,"0"),i=i.toString().padStart(2,"0"),n=n.toString().padStart(2,"0"),a=a.toString().padStart(2,"0"),`${t}:${i} ${n}.${a}.${o}`}function o(e,t){return $.post(ajaxurl,{action:e,...t}).pipe((function(e){try{return JSON.parse(e)}catch(t){return n(t.message,"error"),e}}))}function d(e){const t=document.createElement("td");return"string"==typeof e?t.innerHTML=e:t.appendChild(e),t}function r(e){const t=document.createElement("img");return t.src=e,t}function c(e){const t=document.createElement("span");t.setAttribute("data-id",e.id),t.classList.add("skip-image"),t.appendChild(r(e.src));const n=document.createElement("button");n.addEventListener("click",(function(){!function(e){let t=i.skipImages.getAttribute("data-ids");if(!t)return;try{t=JSON.parse(t).map((e=>e.id))}catch(e){return void console.error(e)}const n=t.indexOf(e);n>=0&&(t.splice(n,1),0===t.length&&(t=!1),o("media-clean-set-skip",{ids:t}).done((function(e){i.skipImages.innerHTML='<div class="loading"><div></div><div></div><div></div><div></div></div>',p()})))}(e.id)})),n.classList.add("remove");const a=document.createElement("i");return n.appendChild(a),t.appendChild(n),t}function s(e){const t=document.createElement("span");t.classList.add("chip");const i=document.createElement("i");i.className="wp-menu-image dashicons-before dashicons-open-folder",t.appendChild(i);const n=document.createElement("span");if(n.innerHTML=e.name,t.appendChild(n),e.count){const i=document.createElement("span");i.classList.add("count"),i.innerHTML=e.count,t.appendChild(i)}return t.setAttribute("data-id",e.id),t}function l(){const e=this.getAttribute("data-page");i.cacheTable.setAttribute("data-page",e),v()}function u(){o("media-clean-get-count",{}).done((function(e){i.activeCount.innerHTML=e.count;const t=Number.parseInt(i.count.innerHTML),n=Number.parseInt(e);Number.isNaN(t)||Number.isNaN(n)?(i.progress.removeAttribute("max"),i.progress.removeAttribute("value")):(i.progress.setAttribute("max",t),i.progress.setAttribute("value",t-n))})).fail((function(){console.error("error")}))}function p(){o("media-clean-get-options",{}).done((function(e){for(const n of e)switch(n.option_key){case"status":i.status.innerHTML=t.STATUS[n.option_value],n.option_value.startsWith("process")&&(i.progress.parentNode.classList.add("show"),i.refreshBtn.setAttribute("disabled",""),i.purgeBtn.setAttribute("disabled","")),n.option_value.startsWith("finish")&&(i.progress.parentNode.classList.remove("show"),i.refreshBtn.removeAttribute("disabled"),i.purgeBtn.removeAttribute("disabled"));break;case"last_update":const e=new Date(n.option_value);i.lastUpdate.innerHTML=a(e);break;case"count":i.count.innerHTML=n.option_value;break;case"skip_ids":let o=Array.from(i.skipImages.querySelectorAll("img"));if(0===o.length&&(i.skipImages.innerHTML=""),o=o.map((e=>e.src)),Array.isArray(n.option_value)){i.skipImages.setAttribute("data-ids",JSON.stringify(n.option_value));for(const e of n.option_value)o.includes(e.src)||i.skipImages.appendChild(c(e));const e=n.option_value.map((e=>e[0]));for(const t of o)if(!e.includes(t)){const e=i.skipFilebirdFolder.querySelector(`img[src="${t}"]`);e&&e.parentNode.removeChild(e)}}break;case"external_plugin_filebird_ids":let d=Array.from(i.skipFilebirdFolder.querySelectorAll(".chip"));if(0===d.length&&(i.skipFilebirdFolder.innerHTML=""),d=d.map((e=>e.getAttribute("data-id"))),Array.isArray(n.option_value)){for(const e of n.option_value)d.includes(e.id)||i.skipFilebirdFolder.appendChild(s(e));const e=n.option_value.map((e=>e.id));for(const t of d)if(!e.includes(t)){const e=i.skipFilebirdFolder.querySelector(`.chip[data-id="${t}"]`);e&&e.parentNode.removeChild(e)}}}})).fail((function(){console.error("error")}))}function v(){const e=i.cacheTable;if(!e)return alert("Fehler");e.classList.add("is-loading"),i.cacheTotal.innerHTML='<div class="loading"><div></div><div></div><div></div><div></div></div>';o("media-clean-get-cache",{page:e.getAttribute("data-page")||1,limit:e.getAttribute("data-limit")||20}).done((function(n){if(!n.data)return;i.cacheTotal.innerHTML=n.total,e.setAttribute("data-total",n.total),function(){const e=i.cacheTable.getAttribute("data-total")||"0",t=i.cacheTable.getAttribute("data-limit"),n=i.cacheTable.getAttribute("data-page"),a=Math.ceil(e/t),o=i.cachePagination;o.innerHTML="";for(let e=1;e<=a;e++){const t=document.createElement("li"),i=document.createElement("button");n==e&&i.classList.add("active"),i.setAttribute("data-page",e),i.innerHTML=e,i.addEventListener("click",l),t.appendChild(i),o.appendChild(t)}console.log(a)}();const o=n.data;e.classList.remove("is-loading");const c=e.querySelector("tbody");if(c.innerHTML="",0===o.length){e.classList.remove("fill");const i=document.createElement("tr"),n=d(t["No data available."]);n.setAttribute("colspan",e.querySelectorAll("th").length),i.appendChild(n),c.appendChild(i)}else{e.classList.add("fill");for(const e of o){const t=document.createElement("tr"),i=new Date(e.post_modified);t.appendChild(d(e.id));const n=d(r(e.img[0]));n.classList.add("column-primary"),t.appendChild(n),t.appendChild(d(e.post_title)),t.appendChild(d(a(i))),c.appendChild(t)}}})).fail((function(){console.error("error")}))}function m(){e.querySelector("[data-init-filebird]")&&function(){let n=[];e.querySelector("[data-select-filebird-folder]").addEventListener("click",(function(){var e=$('<div class="m-fpm-media-cleaner__dialog">\n          <div class="dialog-content jstree-filebird" data-content="">\n            <center>\n              <div class="loading"><div></div><div></div><div></div><div></div></div>\n            </center>\n          </div>\n        </div>');e.dialog({title:t["Select Filebird Folder"],dialogClass:"wp-dialog wp-core-ui",draggable:!1,modal:!0,autoOpen:!1,closeOnEscape:!0,width:400,buttons:[{text:t.Close,click:function(){e.dialog("close")}},{text:t.Save,click:function(){e.find("[data-content]").html('<center>\n                  <div class="loading"><div></div><div></div><div></div><div></div></div>\n                </center>');let t=n;0===t.length&&(t=!1),o("media-clean-set-filebird-folders",{ids:t}).done((()=>{i.skipFilebirdFolder.innerHTML='<div class="loading"><div></div><div></div><div></div><div></div></div>',p(),e.dialog("close")}))}}],open:function(t,i){o("media-clean-get-filebird-folders").done((function(t){!function(e,t){e.html('<div class="loading"><div></div><div></div><div></div><div></div></div>');const i=function e(t){const i=[];for(const n of t){const t={id:n.id,text:n.name,state:{opened:!0,selected:n.selected},children:[]};n.children&&(t.children=e(n.children)),i.push(t)}return i}(t);e.on("changed.jstree",(function(e,t){n=[];for(let e=0;e<t.selected.length;e++)n.push(Number.parseInt(t.instance.get_node(t.selected[e]).id))})).jstree({core:{themes:{variant:"large"},data:i},checkbox:{keep_selected_style:!1},plugins:["wholerow","checkbox"]})}(e.find("[data-content]"),t)}))}}),e.dialog("open")}))}()}$((function(){e=document.querySelector("[data-fpm-media-cleaner]");try{t=JSON.parse(e.querySelector("[data-js-translations]").innerHTML)}catch(e){n(e.message,"error")}i={status:e.querySelector("[data-options-status]"),lastUpdate:e.querySelector("[data-options-last-update]"),count:e.querySelector("[data-options-count]"),skipImages:e.querySelector("[data-options-skip-image]"),skipFilebirdFolder:e.querySelector("[data-options-skip-filebird-folder]"),progress:e.querySelector("[data-progress]"),refreshBtn:e.querySelector("[data-fill-cache]"),purgeBtn:e.querySelector("[data-remove-images]"),activeCount:e.querySelector("[data-count]"),cacheTable:e.querySelector("[data-clean-media]"),cacheTotal:e.querySelector("[data-cache-total]"),cachePagination:e.querySelector("[data-cache-pagination]")},e&&(setInterval(u,5e3),setInterval(p,5e3),u(),p(),v(),m(),i.refreshBtn.addEventListener("click",(function(){const t=e.querySelector("[data-clean-media]");t&&t.classList.add("is-loading"),o("media-clean-fill-cache",{}).done((function(e){v()})).fail((function(){})),setTimeout((()=>p()),500)})),e.querySelector("[data-clear-skip]").addEventListener("click",(function(){o("media-clean-set-skip",{ids:!1}).done((function(e){i.skipImages.innerHTML='<div class="loading"><div></div><div></div><div></div><div></div></div>',p()}))})),e.querySelector("[data-remove-images]").addEventListener("click",(function(){confirm(t["Do you want to delete the pictures?"])&&(o("media-clean-remove",{}).done((function(e){v()})).fail((function(){console.error("error")})),setTimeout((()=>p()),500))})),e.querySelector("[data-add-skip-images]").addEventListener("click",(function(){const e=wp.media({title:t["Skip Images Select"],library:{type:"image"},multiple:!0,button:{text:t.select}});e.on("select",(function(){o("media-clean-set-skip",{ids:e.state().get("selection").toJSON().map((e=>e.id))}).done((function(e){p()}))})),e.open()})))}))}(jQuery);