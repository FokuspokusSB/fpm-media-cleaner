!function($){"use strict";let e,t;function n(e,t="log"){console[t]("----------------------------------"),console[t]("[FPM Media Cleaner]"),console[t](`${e}`),console[t]("----------------------------------")}function i(e){let t,n,i,r,o;return t=e.getHours(),n=e.getMinutes(),i=e.getDate(),r=e.getMonth()+1,o=e.getFullYear(),t=t.toString().padStart(2,"0"),n=n.toString().padStart(2,"0"),i=i.toString().padStart(2,"0"),r=r.toString().padStart(2,"0"),`${t}:${n} ${i}.${r}.${o}`}function r(e,t){return $.post(ajaxurl,{action:e,...t}).pipe((function(e){try{return JSON.parse(e)}catch(t){return n(t.message,"error"),e}}))}function o(){return{status:e.querySelector("[data-options-status]"),lastUpdate:e.querySelector("[data-options-last-update]"),count:e.querySelector("[data-options-count]"),skipImages:e.querySelector("[data-options-skip-image]"),skipFilebirdFolder:e.querySelector("[data-options-skip-filebird-folder]"),progress:e.querySelector("[data-fpm-media-progress]"),refreshBtn:e.querySelector("[data-fpm-media-cleaner-refresh]"),purgeBtn:e.querySelector("[data-fpm-media-cleaner-remove]"),activeCount:e.querySelector("[data-fpm-media-cleaner-count]")}}function a(e){const t=document.createElement("td");return"string"==typeof e?t.innerHTML=e:t.appendChild(e),t}function s(e){const t=document.createElement("img");return t.src=e,t}function d(e){const t=document.createElement("span");t.setAttribute("data-id",e.id),t.classList.add("skip-image"),t.appendChild(s(e.src));const n=document.createElement("button");n.addEventListener("click",(function(){!function(e){let t=o().skipImages.getAttribute("data-ids");if(!t)return;try{t=JSON.parse(t).map((e=>e.id))}catch(e){return void console.error(e)}const n=t.indexOf(e);n>=0&&(t.splice(n,1),0===t.length&&(t=!1),r("media-clean-set-skip",{ids:t}).done((function(e){o().skipImages.innerHTML="",u()})))}(e.id)})),n.classList.add("remove");const i=document.createElement("i");return i.className="wp-menu-image dashicons-before dashicons-trash",n.appendChild(i),t.appendChild(n),t}function c(e){const t=document.createElement("span");t.classList.add("chip");const n=document.createElement("i");n.className="wp-menu-image dashicons-before dashicons-open-folder",t.appendChild(n);const i=document.createElement("span");if(i.innerHTML=e.name,t.appendChild(i),e.count){const n=document.createElement("span");n.classList.add("count"),n.innerHTML=e.count,t.appendChild(n)}return t.setAttribute("data-id",e.id),t}function l(){const e=o();r("media-clean-get-count",{}).done((function(t){e.activeCount.innerHTML=t.count;const n=Number.parseInt(e.count.innerHTML),i=Number.parseInt(t);Number.isNaN(n)||Number.isNaN(i)?(e.progress.removeAttribute("max"),e.progress.removeAttribute("value")):(e.progress.setAttribute("max",n),e.progress.setAttribute("value",n-i))})).fail((function(){console.error("error")}))}function u(){const e=o();r("media-clean-get-options",{}).done((function(t){for(const n of t)switch(n.option_key){case"status":e.status.innerHTML=n.option_value,n.option_value.startsWith("process")&&(e.progress.parentNode.classList.add("show"),e.refreshBtn.setAttribute("disabled",""),e.purgeBtn.setAttribute("disabled","")),n.option_value.startsWith("finish")&&(e.progress.parentNode.classList.remove("show"),e.refreshBtn.removeAttribute("disabled"),e.purgeBtn.removeAttribute("disabled"));break;case"last_update":const t=new Date(n.option_value);e.lastUpdate.innerHTML=i(t);break;case"count":e.count.innerHTML=n.option_value;break;case"skip_ids":let r=Array.from(e.skipImages.querySelectorAll("img"));if(0===r.length&&(e.skipImages.innerHTML=""),r=r.map((e=>e.src)),Array.isArray(n.option_value)){e.skipImages.setAttribute("data-ids",JSON.stringify(n.option_value));for(const t of n.option_value)r.includes(t.src)||e.skipImages.appendChild(d(t));const t=n.option_value.map((e=>e[0]));for(const n of r)if(!t.includes(n)){const t=e.skipFilebirdFolder.querySelector(`img[src="${n}"]`);t&&t.parentNode.removeChild(t)}}break;case"external_plugin_filebird_ids":let o=Array.from(e.skipFilebirdFolder.querySelectorAll(".chip"));if(0===o.length&&(e.skipFilebirdFolder.innerHTML=""),o=o.map((e=>e.getAttribute("data-id"))),Array.isArray(n.option_value)){for(const t of n.option_value)o.includes(t.id)||e.skipFilebirdFolder.appendChild(c(t));const t=n.option_value.map((e=>e.id));for(const n of o)if(!t.includes(n)){const t=e.skipFilebirdFolder.querySelector(`.chip[data-id="${n}"]`);t&&t.parentNode.removeChild(t)}}}})).fail((function(){console.error("error")}))}function p(){const n=e.querySelector("[data-clean-media]");if(!n)return alert("Fehler");n.classList.add("is-loading"),r("media-clean-get-cache",{}).done((function(e){n.classList.remove("is-loading");const r=n.querySelector("tbody");if(r.innerHTML="",0===e.length){n.classList.remove("fill");const e=document.createElement("tr"),i=a(t["No data available."]);i.setAttribute("colspan",n.querySelectorAll("th").length),e.appendChild(i),r.appendChild(e)}else{n.classList.add("fill");for(const t of e){const e=document.createElement("tr");e.appendChild(a(t.id)),e.appendChild(a(s(t.img[0])));const n=new Date(t.post_modified);e.appendChild(a(t.post_title));const o=a(i(n));o.setAttribute("colspan","2"),e.appendChild(o),r.appendChild(e)}}})).fail((function(){console.error("error")}))}function m(){e.querySelector("[data-init-filebird]")&&function(){let n=[];e.querySelector("[data-select-filebird-folder]").addEventListener("click",(function(){var e=$('<div class="m-fpm-media-cleaner">\n          <div class="dialog-content jstree-filebird" data-content="">\n            <center>\n              <div class="loading"><div></div><div></div><div></div><div></div></div>\n            </center>\n          </div>\n        </div>');e.dialog({title:t["Select Filebird Folder"],dialogClass:"wp-dialog wp-core-ui",draggable:!1,modal:!0,autoOpen:!1,closeOnEscape:!0,width:400,buttons:[{text:t.Close,click:function(){e.dialog("close")}},{text:t.Save,click:function(){e.find("[data-content]").html('<center>\n                  <div class="loading"><div></div><div></div><div></div><div></div></div>\n                </center>');let t=n;0===t.length&&(t=!1),r("media-clean-set-filebird-folders",{ids:t}).done((()=>{o().skipFilebirdFolder.innerHTML='<div class="loading"><div></div><div></div><div></div><div></div></div>',u(),e.dialog("close")}))}}],open:function(t,i){r("media-clean-get-filebird-folders").done((function(t){!function(e,t){e.html("");const i=function e(t){const n=[];for(const i of t){const t={id:i.id,text:i.name,state:{opened:!0,selected:i.selected},children:[]};i.children&&(t.children=e(i.children)),n.push(t)}return n}(t);e.on("changed.jstree",(function(e,t){n=[];for(let e=0;e<t.selected.length;e++)n.push(Number.parseInt(t.instance.get_node(t.selected[e]).id))})).jstree({core:{themes:{variant:"large"},data:i},checkbox:{keep_selected_style:!1},plugins:["wholerow","checkbox"]})}(e.find("[data-content]"),t)}))}}),e.dialog("open")}))}()}$((function(){e=document.querySelector("[data-fpm-media-cleaner]");try{t=JSON.parse(e.querySelector("[data-js-translations]").innerHTML)}catch(e){n(e.message,"error")}e&&(setInterval(l,5e3),setInterval(u,5e3),l(),u(),p(),m(),e.querySelector("[data-fpm-media-cleaner-refresh]").addEventListener("click",(function(){r("media-clean-fill-cache",{}).done((function(e){})).fail((function(){})),setTimeout((()=>u()),500)})),e.querySelector("[data-fpm-media-cleaner-clear-skip]").addEventListener("click",(function(){r("media-clean-set-skip",{ids:!1}).done((function(e){o().skipImages.innerHTML='<div class="loading"><div></div><div></div><div></div><div></div></div>',u()}))})),e.querySelector("[data-fpm-media-cleaner-remove]").addEventListener("click",(function(){confirm(t["Do you want to delete the pictures?"])&&(r("media-clean-remove",{}).done((function(e){})).fail((function(){console.error("error")})),setTimeout((()=>u()),500))})),e.querySelector("[data-refresh-cash]").addEventListener("click",(function(){p()})),e.querySelector("[data-add-skip-images]").addEventListener("click",(function(){const e=wp.media({title:t["Skip Images Select"],library:{type:"image"},multiple:!0,button:{text:t.select}});e.on("select",(function(){r("media-clean-set-skip",{ids:e.state().get("selection").toJSON().map((e=>e.id))}).done((function(e){u()}))})),e.open()})))}))}(jQuery);